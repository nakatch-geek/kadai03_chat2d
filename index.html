<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase_version9_RealtimeDB(G'sACADEMYåˆå­¦è€…ç”¨ã‚µãƒ³ãƒ—ãƒ«)</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <h1>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª ğŸ’¬</h1>

    <div class="settings-container">
        <label for="bg-select">èƒŒæ™¯ã‚’é¸æŠ: </label>
        <select id="bg-select"></select>
    </div>
    <div>
        <div>
            <input type="text" id="uname" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        </div>
        <div>
            <textarea id="text" placeholder="æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <button id="send">é€ä¿¡</button>
        <div id="output"></div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

        // Your web app's Firebase configuration 
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); //RealtimeDBã«æ¥ç¶š
        const dbRef = ref(db, "chat"); //RealtimeDBå†…ã®"chat"ã‚’ä½¿ã†

        // --------------------------------------------------
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…ã€è¿½åŠ ã€‘èƒŒæ™¯è¨­å®šã®ãƒ­ã‚¸ãƒƒã‚¯â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // --------------------------------------------------
        const bgImages = [];
        // backgrand01.jpg ~ backgrand11.jpg ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
        for (let i = 1; i <= 11; i++) {
            const fileName = `backgrand${String(i).padStart(2, '0')}.jpg`;
            bgImages.push(fileName);
        }

        const $bgSelect = $("#bg-select");

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç”»åƒã®é¸æŠè‚¢ã‚’è¿½åŠ 
        bgImages.forEach(imgFile => {
            $bgSelect.append(`<option value="${imgFile}">${imgFile}</option>`);
        });
        
        // èƒŒæ™¯ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applyBackground(imageFile) {
            $('body').css('background-image', `url(img/${imageFile})`);
        }

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        $bgSelect.on("change", function() {
            const selectedBg = $(this).val();
            localStorage.setItem("chat_background", selectedBg); // é¸æŠã‚’ä¿å­˜
            applyBackground(selectedBg);
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸèƒŒæ™¯ã‚’é©ç”¨
        const savedBg = localStorage.getItem("chat_background");
        if (savedBg && bgImages.includes(savedBg)) {
            applyBackground(savedBg);
            $bgSelect.val(savedBg);
        } else {
            // ä¿å­˜ã•ã‚ŒãŸèƒŒæ™¯ãŒãªã„å ´åˆã¯ã€1æšç›®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦é©ç”¨
            applyBackground(bgImages[0]);
        }
        // --------------------------------------------------

        // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«localStorageã‹ã‚‰åå‰ã‚’å–å¾—ã—ã¦å…¥åŠ›æ¬„ã«è¨­å®š
        const savedUname = localStorage.getItem("chat_uname");
        if (savedUname) {
            $("#uname").val(savedUname);
        }

        // 2. åå‰å…¥åŠ›æ¬„ã«å¤‰æ›´ãŒã‚ã£ãŸã‚‰localStorageã«ä¿å­˜
        $("#uname").on("change", function() {
            localStorage.setItem("chat_uname", $(this).val());
        });

        // 3. åå‰ã‹ã‚‰è‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function nameToColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }
        
        // 4. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã€ŒYYYY/MM/DD HH:MMã€å½¢å¼ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const HH = String(date.getHours()).padStart(2, '0');
            const MM = String(date.getMinutes()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd} ${HH}:${MM}`;
        }

        //ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Click)
        $("#send").on("click", function () {
            const uname = $("#uname").val();
            const text = $("#text").val();

            if (!uname || !text) {
                alert("åå‰ã¨æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const msg = {
                uname: uname,
                text: text,
                timestamp: Date.now() 
            };
            const newPostRef = push(dbRef);
            set(newPostRef, msg);
            
            $("#text").val("");
        });

        //æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            const key = data.key;

            const myName = localStorage.getItem("chat_uname") || "";
            const messageSideClass = msg.uname === myName ? "my-message" : "other-message";
            const nameColor = nameToColor(msg.uname);
            const formattedTime = formatTimestamp(msg.timestamp);

            let html = `
                <div class="message-wrapper ${messageSideClass}">
                    <div class="message-box">
                        <p class="uname" style="color: ${nameColor};">${msg.uname}</p>
                        <p class="text">${msg.text}</p>
                        <p class="timestamp">${formattedTime}</p>
                    </div>
                </div>
            `;
            $("#output").append(html);
            
            $("#output").scrollTop($("#output")[0].scrollHeight);
        });

    </script>
</body>

</html>